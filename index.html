<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLIP - Red Social de Arte</title>
<style>
body { margin:0; font-family:sans-serif; background:#0f0f0f; color:#fff; }
header { background:#1a1a1a; padding:10px; display:flex; justify-content:space-between; align-items:center; }
button { padding:5px 10px; margin:0 5px; cursor:pointer; }
#auth, #chat { max-width:600px; margin:20px auto; display:none; }
#messages { border:1px solid #333; padding:10px; height:300px; overflow-y:auto; margin-bottom:10px; }
input, textarea { width:100%; padding:5px; margin-bottom:10px; background:#222; color:#fff; border:none; }
input::placeholder, textarea::placeholder { color:#888; }
img { max-width:100%; margin-top:5px; border-radius:5px; }
</style>
</head>
<body>

<header>
  <h2>BLIP - Red Social de Arte</h2>
  <div>
    <button id="btnShowAuth">Iniciar sesión / Registrarse</button>
    <button id="btnShowChat" style="display:none;">Chat Global</button>
    <button id="btnLogout" style="display:none;">Cerrar sesión</button>
  </div>
</header>

<div id="auth">
  <h3>Autenticación</h3>
  <input type="email" id="email" placeholder="Correo electrónico">
  <input type="password" id="password" placeholder="Contraseña">
  <button id="btnLogin">Iniciar sesión</button>
  <button id="btnRegister">Registrarse</button>
  <p id="authMsg"></p>
</div>

<div id="chat">
  <h3>Chat Global</h3>
  <div id="messages"></div>
  <textarea id="messageInput" placeholder="Escribe tu mensaje..."></textarea>
  <input type="file" id="fileInput" accept="image/*">
  <button id="btnSend">Enviar</button>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

// Configuración Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA5yh8J7Mgij3iZCOEZ2N8r1yhDkLcXsTg",
  authDomain: "almacenamiento-redsocial.firebaseapp.com",
  databaseURL: "https://almacenamiento-redsocial-default-rtdb.firebaseio.com",
  projectId: "almacenamiento-redsocial",
  storageBucket: "almacenamiento-redsocial.firebasestorage.app",
  messagingSenderId: "562861595597",
  appId: "1:562861595597:web:f9e5764ea977b72fa9c284",
  measurementId: "G-KZXC1T5EFD"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Cloudinary config
const cloudName = "dz9s37bk0";
const unsignedPreset = "blip_unsigned";

// Elementos
const authDiv = document.getElementById("auth");
const chatDiv = document.getElementById("chat");
const btnShowAuth = document.getElementById("btnShowAuth");
const btnShowChat = document.getElementById("btnShowChat");
const btnLogout = document.getElementById("btnLogout");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const authMsg = document.getElementById("authMsg");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const fileInput = document.getElementById("fileInput");

// Mostrar/ocultar secciones
btnShowAuth.onclick = () => { authDiv.style.display='block'; chatDiv.style.display='none'; };
btnShowChat.onclick = () => { chatDiv.style.display='block'; authDiv.style.display='none'; };

// Registro
document.getElementById("btnRegister").onclick = () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  createUserWithEmailAndPassword(auth, email, password)
    .then(() => { authMsg.textContent = "Registrado correctamente!"; })
    .catch(e => { authMsg.textContent = e.message; });
};

// Login
document.getElementById("btnLogin").onclick = () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  signInWithEmailAndPassword(auth, email, password)
    .then(() => { authMsg.textContent = ""; })
    .catch(e => { authMsg.textContent = e.message; });
};

// Detectar estado de sesión
onAuthStateChanged(auth, user => {
  if(user){
    authDiv.style.display = 'none';
    chatDiv.style.display = 'block';
    btnShowChat.style.display = 'inline';
    btnLogout.style.display = 'inline';
  } else {
    authDiv.style.display = 'block';
    chatDiv.style.display = 'none';
    btnShowChat.style.display = 'none';
    btnLogout.style.display = 'none';
  }
});

// Logout
btnLogout.onclick = () => { signOut(auth); };

// Función para subir imagen a Cloudinary
async function uploadImage(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', unsignedPreset);
  const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
    method: 'POST',
    body: formData
  });
  const data = await res.json();
  return data.secure_url; // URL de la imagen
}

// Enviar mensaje (texto + imagen opcional)
document.getElementById("btnSend").onclick = async () => {
  let imageUrl = null;
  if(fileInput.files.length > 0) {
    imageUrl = await uploadImage(fileInput.files[0]);
  }
  const msg = messageInput.value.trim();
  if(msg === "" && !imageUrl) return; // No enviar mensaje vacío
  push(ref(db, "messages"), {
    user: auth.currentUser.email,
    text: msg,
    image: imageUrl || null,
    timestamp: Date.now()
  });
  messageInput.value = "";
  fileInput.value = "";
};

// Escuchar mensajes
onChildAdded(ref(db, "messages"), snapshot => {
  const data = snapshot.val();
  const div = document.createElement("div");
  const time = new Date(data.timestamp).toLocaleTimeString();
  div.innerHTML = `[${time}] <b>${data.user}</b>: ${data.text || ""}`;
  if(data.image) {
    const img = document.createElement("img");
    img.src = data.image;
    div.appendChild(img);
  }
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>

</body>
</html>
